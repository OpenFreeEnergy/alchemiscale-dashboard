# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Alchemiscale Dashboard is a Next.js 16 + React 19 web interface for the Alchemiscale API (a platform for managing free energy calculations). The TypeScript API client is **auto-generated** from an OpenAPI spec.

## Commands

- `npm run dev` — Start dev server (localhost:3000)
- `npm run build` — Production build
- `npm run lint` — ESLint (uses flat config, ignores `src/client/**`)
- No test framework is currently configured

### Regenerating the API Client

```bash
npx openapi-typescript-codegen --input ../devtools/openapi/openapi.json --output ./src/client --client fetch
```

## Environment Variables

- `NEXT_PUBLIC_ALCHEMISCALE_API_URL` — (required, client-exposed) Alchemiscale API base URL
- `AWS_S3_BUCKET` — (server-only) S3/R2 bucket name, used by `/api/r2/*` routes
- AWS credentials are expected from environment/IAM for S3 access

## Architecture

### Auto-generated Client (`src/client/`)

**Do not manually edit files in `src/client/`.** This directory is generated by `openapi-typescript-codegen` and ESLint ignores it. Key exports:

- `OpenAPI` — Global config singleton (`BASE`, `TOKEN`, `WITH_CREDENTIALS`)
- `DefaultService` — Static class with all API methods
- `ApiError` — Has `.status` property, used for 401 detection
- Model types: `Token`, `ScopedKey`, and `Body_*` request types

### Authentication

No React Context or state library. Auth is managed via two mechanisms in parallel:

1. **In-memory:** `OpenAPI.TOKEN` (set via `setAuthToken()` from `src/lib/alchemiscale-client.ts`)
2. **Persistent:** `localStorage` keys `alchemiscale_token` and `alchemiscale_username` (via `src/lib/storage.ts`)

Both must be set/cleared together. The `useAuthenticatedPage` hook restores the in-memory token from localStorage on page mount. `handleAuthError()` in `src/lib/auth-errors.ts` auto-clears both on 401.

### Data Fetching

- **`useApiData<T>` hook** (`src/hooks/useApiData.ts`) — Generic fetch-on-mount hook returning `{ data, loading, error, refetch }`. Uses refs to prevent StrictMode double-fetching. Detail pages pass `enabled: activeTab === 'tabName'` for lazy tab-based loading.
- **`/api/r2/*` routes** — Server-side Next.js Route Handlers that proxy S3/R2 requests, keeping AWS credentials server-side. Called via raw `fetch()` from client components (not via `DefaultService`).

### Page Structure

All pages under `src/app/` are `'use client'` components. Only the root layout (`layout.tsx`) is a server component.

- `/dashboard` — Login/logout hub, entry point for auth
- `/networks` — Query by scope/name/state
- `/networks/[scoped_key]` — Tabbed detail view (Status, Details, Transformations, Chemical Systems); tabs are URL-driven via `?tab=` query param
- `/transformations/[scoped_key]` — SMILES molecule viewer + task table
- `/chemicalsystems/[scoped_key]` — JSON tree viewer
- `/debug` — API diagnostics + R2 bucket browser

### Data Transform Utilities (`src/lib/dataTransform.ts`)

The Alchemiscale API returns some objects as `[key, value]` 2-tuple arrays instead of plain objects. `convertTupleListToObject()` recursively normalizes these. `extractPropertyByKeyPattern()` and `extractPropertiesFromMultipleKeys()` pull values from keys matching a prefix (e.g. `"SmallMoleculeComponent-"`).

### Component Patterns

- `SmilesViewer` — Dynamically imports `openchemlib` client-side, renders molecule SVG from SMILES strings via `dangerouslySetInnerHTML`
- `TransformationTasksTable` / `TaskRow` — Fetches task status per-task (N+1 pattern); `TaskRow` also fetches S3 checkpoint data via `/api/r2/*` routes
- `AuthGate` — Render guard that shows login prompt when unauthenticated
- `DetailPageLayout` — Shared layout wrapper for entity detail pages

### Path Aliases

`@/*` maps to `./src/*` (configured in `tsconfig.json`).
